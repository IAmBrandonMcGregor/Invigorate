<!doctype html>
<!--[if lt IE 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>InvigorateJS</title>

    <!-- Meta tag to normalize desktop & mobile viewport behavior. -->
    <meta name="viewport" content="width=device-width, user-scalable=no,maximum-scale=1,initial-scale=1">

    <!-- Include threadit.js -->
    <script src="threadit.js"></script>

</head>

<style>
    #my-invigorate-wrapper {
        width: 200%;
        text-align: center;
    }
    #move-me-one {
        background-color: green;
    }
    #move-me-two {
        background-color: blue;
    }
    .wrapper {
        width: 100%;
        overflow: auto;
    }
</style>

<body>
    <h1>InvigorateJS</h1>
    <div class="wrapper">
        <section id="my-invigorate-wrapper">
            <span id="move-me-one">Move Me One</span>
            <span id="move-me-two">Move Me Two</span>
        </section>
    </div>
</body>

<script>

    (function CreateTheInvigorateJSLibrary () {


        // Invigorate Constructor.
        // -----------------------
        function Invigorate (config) {

            // setup the theater.
            this.theater = config.theater;

            // setup the setpieces placeholder.
            this.setPieces = config.setPieces;

            this.numberOfFrames = (config.numberOfFrames || 100);

            this.reinvigorate();

            return this;
        }

        // Prototype-Level Functions.
        // --------------------------
        Invigorate.prototype.reinvigorate = function reinvigorate () {
            var self = this,
                workers = [],
                i, l;
            for (i=0, l=this.setPieces.length; i<l; i++) {
                // workers[workers.length] = GenerateFramesWithWorker({
                //     numberOfFrames: self.numberOfFrames,
                //     keyframes:self.setPieces[i].keyframes
                // });
                workers[workers.length] = Threadit(CreateFrames, {
                    numberOfFrames: self.numberOfFrames,
                    keyframes:self.setPieces[i].keyframes
                });
            }

            this.promise = Promise.all(workers).then(function (framesets) {
                // set the frames using the data returned by the workers.
                for (i=0, l=framesets.length; i<l; i++)
                    self.setPieces[i].frames = framesets[i];
                return self;
            });

            return this;
        };

        // Private Functions.
        // ------------------
        function CreateFrames (options) {

            // reference the keyframes
            var keyframes = options.keyframes;

            // create an base array of frames.
            var frames = [];
            for (var i=0,l=options.numberOfFrames+1; i<l; i++)
                frames[i] = {};

            // Get an array of properties that will be modified.
            var properties = GetProperties(options.keyframes);

            // calculate and populate each frame.
            var frame, property;
            for (var i=0, l=frames.length; i<l; i++) {
                frame = frames[i];

                // attach properties on this keyframe.
                for (var pi=0, pl=properties.length; pi<pl; pi++) {
                    property = properties[pi];

                    // if property is set on this keyframe...
                    if (keyframes[i] && typeof keyframes[i][property.name] !== 'undefined') {

                        // set the property to the defined value.
                        frame[property.name] = keyframes[i][property.name];

                        // transition the frames since the last change.
                        if (i !== 0) {
                            TransitionFrames(
                                frames.slice(property.lastKeyframeIdx, i+1),
                                property.name
                            );
                        }

                        // replace the 'lastKeyframeIdx' tracker.
                        property.lastKeyframeIdx = i;
                    }
                    // ...otherwise carry-over the value from the last frame.
                    else {
                        frame[property.name] = frames[i-1][property.name];
                    }
                }
            }

            return frames;

            // Private Function Definitions.
            // -----------------------------

            // Gets a list of all properties that are animated on this set piece.
            function GetProperties (keyframes) {
                var properties = [];

                // create an array of property names.
                for (var keyframe in keyframes) {
                    keyframe = keyframes[keyframe];
                    for (var property in keyframe) {
                        if (properties.indexOf(property) === -1)
                            properties[properties.length] = property;
                    }
                }

                // transform property strings into property objects.
                for (var i=0,l=properties.length; i<l; i++) {
                    properties[i] = { name: properties[i] }
                }

                return properties;
            }

            // Gets the incrementer value for smoothing between keyframe values.
            function TransitionFrames (framesToTransition, propertyName, transitionType) {

                // determine start and end values.
                var endValue = framesToTransition[framesToTransition.length-1][propertyName],
                    startValue = framesToTransition[0][propertyName];

                // don't bother looping if the values don't need transitioning.
                if (endValue === startValue)
                    return framesToTransition;

                // linear transition (default).
                if (!transitionType || transitionType === 'linear') {
                    var increment = ((endValue - startValue) / framesToTransition.length);

                    for (var i=1,l=framesToTransition.length-1; i<l; i++) {
                        framesToTransition[i][propertyName] += (increment * i);
                    }
                }

                return framesToTransition;
            }
        }

        // Attach Invigorate to the document for out-of-closure use.
        // ---------------------------------------------------------
        this.Invigorate = Invigorate;

    })();


    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    // - - - - - - - - - - - - TEST USAGE! - - - - - - - - - - - - - - -
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


    var myInvigorate = new Invigorate({
        theater: document.getElementById('my-invigorate-wrapper'),
        setPieces: [
            {
                element: document.getElementById('move-me-one'),
                keyframes: {
                    0: { height: 50, opacity: 1 },
                    99: { opacity: 0.5},
                    300: { height: 200, opacity: 0.5 },
                    500: { opacity: 1 }
                }
            },
            {
                element: document.getElementById('move-me-two'),
                keyframes: {
                    0: { height: 200 },
                    500: { height: 50 }
                }
            }
        ],
        // Optional
        // --------
        numberOfFrames: 500
    });
    
    myInvigorate.promise.then(function (result) {
        console.log('Promise worked!');
        console.log(result);
        console.log(myInvigorate);
    });

    // // This would return an object containing functions and a collection of 
    // // setPieces that have frame collections.
    // myInvigorateObject.reinvigorate();
    // myInvigorateObject.setPieces;

</script>

</html>
